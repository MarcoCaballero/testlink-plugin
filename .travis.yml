sudo: required
language: java
install: true
jdk:
 - oraclejdk8

services:
  - docker

addons:
  sonarcloud:
    organization: "marcocaballero-github"
    token:
      secure: "$SONAR_TOKEN"

before_script:
  - cd testlink-plugin
  - mvn clean org.jacoco:jacoco-maven-plugin:prepare-agent package sonar:sonar
  - mvn dockerfile:build
  - cd .. 
  - cd testlink-plugin-gui
  - docker build -t marcocab/testlink-plugin-gui:dev .
  - cd ..
script:
  - docker-compose up -d
after_success:
  - docker-compose down --volumes --remove-orphans
after_script:
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin 
  - chmod u*x deploy_stable.sh
  - chmod u*x deploy_dev.sh
  - if [[ $TRAVIS_COMMIT_MESSAGE == *"[--deploy-DockerHub]"* ]]; 
    then ./deploy_stable.sh;
    else ./deploy_dev.sh;
    fi;
cache:
  directories:
    - '$HOME/.sonar/cache'